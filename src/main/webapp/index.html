<!DOCTYPE html>
<html>
  <head>
    <title>Testing Jakarta Security</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  </head>
  <body>
    <h3>Issuie detected</h3>
    <h4><code>403 Forbidden</code> response after simultaneous ajax requests</h4>
    <h5>OS Tested</h5>
    <ul>
      <li>Windows 11 Pro</li>
      <li>Windows 11 Home Single Language</li>
      <li>Windows Server 2012</li>
    </ul>
    <h5>GlassFiah version tested</h5>
    <ul>
      <li>7.0.18</li>
      <li>7.0.18</li>
    </ul>
    <h5>Jakarta EE version</h5>
    <ul>
      <li>10</li>
    </ul>
    <h5>Java version</h5>
    <ul>
      <li>17</li>
    </ul>
    <p>Request load
      <select>
        <option value="5" selected>5</option>
        <option value="10">10</option>
        <option value="15">15</option>
        <option value="20">20</option>
      </select>
    </p>
    <p>Target
      <select>
        <option value="servlet" selected>Servlet</option>
        <option value="service">Web Service</option>
      </select>
    </p>
    <button onclick="startTest()">Start test</button>
    <table border="1">
      <thead>
        <tr>
          <th>Method</th>
          <th>URL</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td colspan="3">Waiting</td>
        </tr>
      </tbody>
    </table>
    <script>
      let table = document.getElementsByTagName('table tbody')[0];
      let tbody = document.querySelector('table tbody');
      let selects = document.querySelectorAll('select');
      let config = {
        servlet: {
          method: 'GET',
          url: 'servlet'
        },
        service: {
          method: 'GET',
          url: 'resources/service'
        }
      };
      function startTest() {
        deleteRow();
        settingAjax();
      }
      function deleteRow() {
        let tr = document.querySelectorAll('table tbody tr');
        for (let i = 0; i < tr.length; i++) {
          tr[i].parentNode.removeChild(tr[i]);
        }
      }
      function settingAjax() {
        let load = selects[0].value;
        let target = selects[1].value;
        for (let i = 0; i < load; i++) {
          ajaxRequest(config[target]);
        }
      }
      function generateRow( {method, url, status}) {
        let html = [];
        html.push(
                '<tr>',
                '<td>' + method + '</td>',
                '<td>' + url + '</td>',
                '<td>' + status + '</td>',
                '</tr>'
                );
        return html.join('');
      }
      function ajaxRequest( {method, url}) {
        const xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
          if (this.readyState === 4) {
            let status = this.status;
            tbody.innerHTML += generateRow({method, url, status});
          }
        };
        xhttp.open(method, url);
        xhttp.send();
      }
    </script>
  </body>
</html>
